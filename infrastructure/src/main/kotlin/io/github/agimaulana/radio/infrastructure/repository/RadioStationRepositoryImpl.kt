package io.github.agimaulana.radio.infrastructure.repository

import com.squareup.moshi.Moshi
import com.squareup.moshi.Types
import com.squareup.moshi.addAdapter
import com.squareup.moshi.kotlin.reflect.KotlinJsonAdapterFactory
import io.github.agimaulana.radio.core.common.DispatcherProvider
import io.github.agimaulana.radio.domain.api.entity.RadioStation
import io.github.agimaulana.radio.domain.api.repository.RadioStationRepository
import io.github.agimaulana.radio.infrastructure.api.RadioStationApi
import io.github.agimaulana.radio.infrastructure.response.RadioStationResponse
import io.github.agimaulana.radio.infrastructure.response.RadioStationResponseJsonAdapter
import kotlinx.coroutines.withContext
import javax.inject.Inject

class RadioStationRepositoryImpl @Inject constructor(
    private val radioStationApi: RadioStationApi,
    private val dispatcherProvider: DispatcherProvider,
) : RadioStationRepository {

    override suspend fun getRadioStations(page: Int): List<RadioStation> {
        return withContext(dispatcherProvider.io) {
//            radioStationApi.getRadioStations(page)
//                .map { it.toEntity() }
            parseMockResponse()
        }
    }

    override suspend fun getRadioStations(
        searchQuery: String,
        page: Int
    ): List<RadioStation> {
        return withContext(dispatcherProvider.io) {
            parseMockResponse().filter { it.name.lowercase().startsWith(searchQuery.lowercase()) }
        }
    }

    override suspend fun getRadioStation(stationUuid: String): RadioStation {
        return withContext(dispatcherProvider.io) {
            parseMockResponse().first { it.stationUuid == stationUuid }
        }
    }

    private fun parseMockResponse(): List<RadioStation> {
        val moshi = Moshi.Builder()
            .add(KotlinJsonAdapterFactory())
            .build()
        val radioStationListType = Types.newParameterizedType(
            List::class.java,
            RadioStationResponse::class.java
        )
        val adapter = moshi.adapter<List<RadioStationResponse>>(radioStationListType)
        val response = adapter.fromJson(MOCK_RESPONSE_JSON.trimIndent())
        return response?.map { it.toEntity() } ?: emptyList()
    }

    private fun RadioStationResponse.toEntity(): RadioStation {
        return RadioStation(
            stationUuid = this.stationuuid,
            name = this.name,
            imageUrl = this.favicon,
            tags = this.tags.split(","),
            url = this.url,
        )
    }
}

private const val MOCK_RESPONSE_JSON = """
    [
      {
        "changeuuid": "c87b6f63-27d3-4ad3-99b6-8a90da1b2645",
        "stationuuid": "1c3b70d9-39d5-49d5-a81a-77833667a88b",
        "serveruuid": "cb52812d-966d-483f-86af-3448d06167b6",
        "name": "I-Radio Jakarta",
        "url": "http://stream.radiojar.com/4ywdgup3bnzuv",
        "url_resolved": "http://n06.radiojar.com/4ywdgup3bnzuv?rj-ttl=5&rj-tok=AAABm1sM4dgAH8GzXYfdwsZhuA",
        "homepage": "http://iradiofm.com/",
        "favicon": "",
        "tags": "indonesia,pop",
        "country": "Indonesia",
        "countrycode": "ID",
        "iso_3166_2": "",
        "state": "Jakarta",
        "language": "bahasa indonesia,indonesian",
        "languagecodes": "id",
        "votes": 10806,
        "lastchangetime": "2025-11-22 08:57:35",
        "lastchangetime_iso8601": "2025-11-22T08:57:35Z",
        "codec": "AAC",
        "bitrate": 0,
        "hls": 0,
        "lastcheckok": 1,
        "lastchecktime": "2025-12-26 14:22:56",
        "lastchecktime_iso8601": "2025-12-26T14:22:56Z",
        "lastcheckoktime": "2025-12-26 14:22:56",
        "lastcheckoktime_iso8601": "2025-12-26T14:22:56Z",
        "lastlocalchecktime": "2025-12-25 16:24:33",
        "lastlocalchecktime_iso8601": "2025-12-25T16:24:33Z",
        "clicktimestamp": "2025-12-26 14:55:20",
        "clicktimestamp_iso8601": "2025-12-26T14:55:20Z",
        "clickcount": 226,
        "clicktrend": -17,
        "ssl_error": 0,
        "geo_lat": null,
        "geo_long": null,
        "geo_distance": null,
        "has_extended_info": false
      },
      {
        "changeuuid": "359e6d37-335f-4ad3-a328-2ac554f4a0ee",
        "stationuuid": "cdd58252-09b9-4c89-b688-243cf107ad29",
        "serveruuid": "6388b329-bbb1-4c1f-89ab-7b1aa6bf1f39",
        "name": "Delta FM Jakarta",
        "url": "http://s1.cloudmu.id:8030/radio.mp3",
        "url_resolved": "http://s1.cloudmu.id:8030/radio.mp3",
        "homepage": "https://www.deltafm.net/",
        "favicon": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSoorUN6xkuaIk6TGP-9ihpdnXm229tGwOtllkyFdsupw&s",
        "tags": "music",
        "country": "Indonesia",
        "countrycode": "ID",
        "iso_3166_2": "",
        "state": "DKI Jakarta",
        "language": "indonesian",
        "languagecodes": "id",
        "votes": 2871,
        "lastchangetime": "2025-11-22 08:57:33",
        "lastchangetime_iso8601": "2025-11-22T08:57:33Z",
        "codec": "AAC+",
        "bitrate": 32,
        "hls": 0,
        "lastcheckok": 1,
        "lastchecktime": "2025-12-26 03:01:12",
        "lastchecktime_iso8601": "2025-12-26T03:01:12Z",
        "lastcheckoktime": "2025-12-26 03:01:12",
        "lastcheckoktime_iso8601": "2025-12-26T03:01:12Z",
        "lastlocalchecktime": "2025-12-26 03:01:12",
        "lastlocalchecktime_iso8601": "2025-12-26T03:01:12Z",
        "clicktimestamp": "2025-12-26 14:55:22",
        "clicktimestamp_iso8601": "2025-12-26T14:55:22Z",
        "clickcount": 195,
        "clicktrend": -4,
        "ssl_error": 0,
        "geo_lat": -6.16020355298332,
        "geo_long": 106.812872747875,
        "geo_distance": null,
        "has_extended_info": false
      },
      {
        "changeuuid": "d38f0f79-200e-4b52-b71f-7a991f0cbcf8",
        "stationuuid": "ab8ee851-2750-475e-ab77-aab0b2c49823",
        "serveruuid": "f0a6457a-fe7e-4c54-b721-ee583cdfcbcf",
        "name": "Prambors FM Jakarta 102.2",
        "url": "https://s2.cloudmu.id/listen/prambors/radio.aac",
        "url_resolved": "http://103.24.105.90:9300/pjkt",
        "homepage": "http://www.pramborsfm.com/",
        "favicon": "https://static.wixstatic.com/media/f66dc6_9dc6cbfe361c4cb0bddbe39262ec761d~mv2.png/v1/fill/w_980,h_980,al_c,q_90,usm_0.66_1.00_0.01,enc_avif,quality_auto/f66dc6_9dc6cbfe361c4cb0bddbe39262ec761d~mv2.png",
        "tags": "hits,music,songs,youth",
        "country": "Indonesia",
        "countrycode": "ID",
        "iso_3166_2": "",
        "state": "Jakarta",
        "language": "english,indonesian",
        "languagecodes": "en,id",
        "votes": 787,
        "lastchangetime": "2025-08-09 07:18:56",
        "lastchangetime_iso8601": "2025-08-09T07:18:56Z",
        "codec": "AAC+",
        "bitrate": 128,
        "hls": 0,
        "lastcheckok": 1,
        "lastchecktime": "2025-12-25 19:59:14",
        "lastchecktime_iso8601": "2025-12-25T19:59:14Z",
        "lastcheckoktime": "2025-12-25 19:59:14",
        "lastcheckoktime_iso8601": "2025-12-25T19:59:14Z",
        "lastlocalchecktime": "2025-12-25 18:42:33",
        "lastlocalchecktime_iso8601": "2025-12-25T18:42:33Z",
        "clicktimestamp": "2025-12-26 14:48:53",
        "clicktimestamp_iso8601": "2025-12-26T14:48:53Z",
        "clickcount": 140,
        "clicktrend": -8,
        "ssl_error": 0,
        "geo_lat": -6.17558647088173,
        "geo_long": 106.827204979369,
        "geo_distance": null,
        "has_extended_info": false
      },
      {
        "changeuuid": "e2d513d6-43d3-4788-ba60-59f51cd133b8",
        "stationuuid": "30ba9673-6034-40ff-966d-b8a8b3da2536",
        "serveruuid": "3b342cb0-1db2-4fe8-b912-e20361e7eea0",
        "name": "Mettaswara Koplo",
        "url": "https://mettaswara.com:8700//koplo",
        "url_resolved": "https://mettaswara.com:8700//koplo",
        "homepage": "https://mettaswara.com/",
        "favicon": "https://static.mytuner.mobi/media/tvos_radios/4kU6XKQHap.png",
        "tags": "koplo",
        "country": "Indonesia",
        "countrycode": "ID",
        "iso_3166_2": "",
        "state": "Jakarta",
        "language": "javanese",
        "languagecodes": "jv",
        "votes": 824,
        "lastchangetime": "2025-11-22 08:57:27",
        "lastchangetime_iso8601": "2025-11-22T08:57:27Z",
        "codec": "AAC",
        "bitrate": 64,
        "hls": 0,
        "lastcheckok": 1,
        "lastchecktime": "2025-12-26 10:37:57",
        "lastchecktime_iso8601": "2025-12-26T10:37:57Z",
        "lastcheckoktime": "2025-12-26 10:37:57",
        "lastcheckoktime_iso8601": "2025-12-26T10:37:57Z",
        "lastlocalchecktime": "2025-12-26 10:37:57",
        "lastlocalchecktime_iso8601": "2025-12-26T10:37:57Z",
        "clicktimestamp": "2025-12-26 14:41:38",
        "clicktimestamp_iso8601": "2025-12-26T14:41:38Z",
        "clickcount": 133,
        "clicktrend": 5,
        "ssl_error": 0,
        "geo_lat": -6.20229873633767,
        "geo_long": 106.821485236287,
        "geo_distance": null,
        "has_extended_info": false
      },
      {
        "changeuuid": "1d161cab-c9c8-4074-b2b2-5bace20bbb48",
        "stationuuid": "6282b213-c07e-4ec7-a8b2-4eb19e18d03b",
        "serveruuid": "744d4ea8-75a1-422f-b7b3-99cfa9c4b013",
        "name": "Gen 98.7 FM Jakarta",
        "url": "http://103.246.184.62:1935/noice_genfm/genfm/chunklist_w279187457.m3u8",
        "url_resolved": "http://103.246.184.62:1935/noice_genfm/genfm/chunklist_w279187457.m3u8",
        "homepage": "https://gen987fm.com/",
        "favicon": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT4VecqCqeZwK-c0osq91dVt4J3xf2ksm1U4g&usqp=CAU",
        "tags": "music,news,talk",
        "country": "Indonesia",
        "countrycode": "ID",
        "iso_3166_2": "",
        "state": "DKI Jakarta",
        "language": "indonesian",
        "languagecodes": "id",
        "votes": 1797,
        "lastchangetime": "2025-11-22 08:57:28",
        "lastchangetime_iso8601": "2025-11-22T08:57:28Z",
        "codec": "UNKNOWN",
        "bitrate": 0,
        "hls": 1,
        "lastcheckok": 1,
        "lastchecktime": "2025-12-26 05:13:48",
        "lastchecktime_iso8601": "2025-12-26T05:13:48Z",
        "lastcheckoktime": "2025-12-26 05:13:48",
        "lastcheckoktime_iso8601": "2025-12-26T05:13:48Z",
        "lastlocalchecktime": "2025-12-26 04:15:42",
        "lastlocalchecktime_iso8601": "2025-12-26T04:15:42Z",
        "clicktimestamp": "2025-12-26 14:55:40",
        "clicktimestamp_iso8601": "2025-12-26T14:55:40Z",
        "clickcount": 124,
        "clicktrend": -17,
        "ssl_error": 0,
        "geo_lat": null,
        "geo_long": null,
        "geo_distance": null,
        "has_extended_info": false
      },
      {
        "changeuuid": "88c54a3c-5b8b-4125-8c3b-41a675b8a71a",
        "stationuuid": "4a81cd8d-4d78-4711-a351-5ccd5bd02d68",
        "serveruuid": "d3e7a1c0-e279-4e64-9336-6ef170f85ab4",
        "name": "DENGERIN MUSIK INDONESIA",
        "url": "https://stream.denger.in/",
        "url_resolved": "https://stream.denger.in/",
        "homepage": "https://denger.in/",
        "favicon": "https://denger.in/logo.png",
        "tags": "pop music,pop rock,top 40",
        "country": "Indonesia",
        "countrycode": "ID",
        "iso_3166_2": "",
        "state": "DMIY",
        "language": "indonesian",
        "languagecodes": "id",
        "votes": 520,
        "lastchangetime": "2025-11-22 08:57:29",
        "lastchangetime_iso8601": "2025-11-22T08:57:29Z",
        "codec": "MP3",
        "bitrate": 128,
        "hls": 0,
        "lastcheckok": 1,
        "lastchecktime": "2025-12-26 01:09:47",
        "lastchecktime_iso8601": "2025-12-26T01:09:47Z",
        "lastcheckoktime": "2025-12-26 01:09:47",
        "lastcheckoktime_iso8601": "2025-12-26T01:09:47Z",
        "lastlocalchecktime": "2025-12-25 22:15:51",
        "lastlocalchecktime_iso8601": "2025-12-25T22:15:51Z",
        "clicktimestamp": "2025-12-26 14:41:27",
        "clicktimestamp_iso8601": "2025-12-26T14:41:27Z",
        "clickcount": 114,
        "clicktrend": 1,
        "ssl_error": 0,
        "geo_lat": -7.78647738604139,
        "geo_long": 110.361549854279,
        "geo_distance": null,
        "has_extended_info": false
      },
      {
        "changeuuid": "b7f2b084-4ad5-438e-bc90-0bd1cee1c6f8",
        "stationuuid": "537e27f1-da35-4b91-b057-a8a1041a23c8",
        "serveruuid": "24369946-8e08-434e-8b69-81f37e899eb4",
        "name": "Dahlia Bandung 101.5 FM",
        "url": "https://svara-stream.radioddns.net/bandung_dahliafm",
        "url_resolved": "https://svara-stream.radioddns.net/bandung_dahliafm",
        "homepage": "https://www.radiodahliafm.com/",
        "favicon": "https://www.radiodahliafm.com/frontend/img/about/favicon.ico",
        "tags": "pop",
        "country": "Indonesia",
        "countrycode": "ID",
        "iso_3166_2": "",
        "state": "Bandung",
        "language": "",
        "languagecodes": "",
        "votes": 626,
        "lastchangetime": "2025-06-12 17:41:23",
        "lastchangetime_iso8601": "2025-06-12T17:41:23Z",
        "codec": "MP3",
        "bitrate": 128,
        "hls": 0,
        "lastcheckok": 1,
        "lastchecktime": "2025-12-26 07:59:54",
        "lastchecktime_iso8601": "2025-12-26T07:59:54Z",
        "lastcheckoktime": "2025-12-26 07:59:54",
        "lastcheckoktime_iso8601": "2025-12-26T07:59:54Z",
        "lastlocalchecktime": "2025-12-25 16:01:09",
        "lastlocalchecktime_iso8601": "2025-12-25T16:01:09Z",
        "clicktimestamp": "2025-12-26 14:38:32",
        "clicktimestamp_iso8601": "2025-12-26T14:38:32Z",
        "clickcount": 94,
        "clicktrend": -16,
        "ssl_error": 0,
        "geo_lat": null,
        "geo_long": null,
        "geo_distance": null,
        "has_extended_info": false
      },
      {
        "changeuuid": "7191e13c-8767-40bd-b75c-29a0dc7182ff",
        "stationuuid": "aa3cee2f-df72-11e8-a9cc-52543be04c81",
        "serveruuid": "0639d970-4b0b-4c48-9cc7-5afff73caf55",
        "name": "CNN Indonesia TV",
        "url": "http://live.cnnindonesia.com/livecnn/smil:cnntv.smil/chunklist_w275412545_b384000_sleng.m3u8",
        "url_resolved": "http://live.cnnindonesia.com/livecnn/smil:cnntv.smil/chunklist_w275412545_b384000_sleng.m3u8",
        "homepage": "http://www.cnnindonesia.com/",
        "favicon": "https://cdn.cnnindonesia.com/cnnid/mobile/images/logo__cnn.png?v=10.16.9",
        "tags": "",
        "country": "Indonesia",
        "countrycode": "ID",
        "iso_3166_2": "",
        "state": "Jakarta",
        "language": "bahasa indonesia",
        "languagecodes": "",
        "votes": 8555,
        "lastchangetime": "2025-06-12 17:41:22",
        "lastchangetime_iso8601": "2025-06-12T17:41:22Z",
        "codec": "UNKNOWN",
        "bitrate": 0,
        "hls": 1,
        "lastcheckok": 1,
        "lastchecktime": "2025-12-26 05:26:42",
        "lastchecktime_iso8601": "2025-12-26T05:26:42Z",
        "lastcheckoktime": "2025-12-26 05:26:42",
        "lastcheckoktime_iso8601": "2025-12-26T05:26:42Z",
        "lastlocalchecktime": "2025-12-25 18:07:24",
        "lastlocalchecktime_iso8601": "2025-12-25T18:07:24Z",
        "clicktimestamp": "2025-12-26 14:09:25",
        "clicktimestamp_iso8601": "2025-12-26T14:09:25Z",
        "clickcount": 89,
        "clicktrend": 0,
        "ssl_error": 0,
        "geo_lat": null,
        "geo_long": null,
        "geo_distance": null,
        "has_extended_info": false
      },
      {
        "changeuuid": "1195c626-0690-4aac-8f85-1cd9671e7515",
        "stationuuid": "5f96f5c1-e75a-4129-abd3-d7e08360fa56",
        "serveruuid": "6b2daa04-7cf7-4c98-8393-35d9d77455f4",
        "name": "Radio Dangdut 97.1 FM Jakarta",
        "url": "http://202.147.199.99:8000/;",
        "url_resolved": "http://202.147.199.99:8000/;",
        "homepage": "http://www.rdifm.co.id/",
        "favicon": "http://www.hit-tuner.net/images/radiologos/img_laender/radio_dangdut_971.png",
        "tags": "",
        "country": "Indonesia",
        "countrycode": "ID",
        "iso_3166_2": "",
        "state": "",
        "language": "",
        "languagecodes": "",
        "votes": 5259,
        "lastchangetime": "2025-06-15 04:21:20",
        "lastchangetime_iso8601": "2025-06-15T04:21:20Z",
        "codec": "MP3",
        "bitrate": 256,
        "hls": 0,
        "lastcheckok": 1,
        "lastchecktime": "2025-12-26 06:12:21",
        "lastchecktime_iso8601": "2025-12-26T06:12:21Z",
        "lastcheckoktime": "2025-12-26 06:12:21",
        "lastcheckoktime_iso8601": "2025-12-26T06:12:21Z",
        "lastlocalchecktime": "2025-12-25 20:25:24",
        "lastlocalchecktime_iso8601": "2025-12-25T20:25:24Z",
        "clicktimestamp": "2025-12-26 14:39:27",
        "clicktimestamp_iso8601": "2025-12-26T14:39:27Z",
        "clickcount": 87,
        "clicktrend": 1,
        "ssl_error": 0,
        "geo_lat": null,
        "geo_long": null,
        "geo_distance": null,
        "has_extended_info": false
      },
      {
        "changeuuid": "80470a41-1040-4ebf-9c55-986f61bd4164",
        "stationuuid": "38c09fe6-481f-4f49-a52e-ce21adabd16d",
        "serveruuid": "744d4ea8-75a1-422f-b7b3-99cfa9c4b013",
        "name": "Jak 101 FM",
        "url": "http://103.246.184.62:1935/noice_jakfm/jakfm/chunklist_w1246572933.m3u8",
        "url_resolved": "http://103.246.184.62:1935/noice_jakfm/jakfm/chunklist_w1246572933.m3u8",
        "homepage": "https://jak101fm.com/",
        "favicon": "https://jak101fm.com/wp-content/uploads/2020/08/cropped-logo-jak-bar-1-180x180.png",
        "tags": "music,news,talk",
        "country": "Indonesia",
        "countrycode": "ID",
        "iso_3166_2": "",
        "state": "DKI Jakarta",
        "language": "indonesian",
        "languagecodes": "id",
        "votes": 1202,
        "lastchangetime": "2025-11-22 08:57:25",
        "lastchangetime_iso8601": "2025-11-22T08:57:25Z",
        "codec": "UNKNOWN",
        "bitrate": 0,
        "hls": 1,
        "lastcheckok": 1,
        "lastchecktime": "2025-12-26 09:09:56",
        "lastchecktime_iso8601": "2025-12-26T09:09:56Z",
        "lastcheckoktime": "2025-12-26 09:09:56",
        "lastcheckoktime_iso8601": "2025-12-26T09:09:56Z",
        "lastlocalchecktime": "2025-12-26 09:09:56",
        "lastlocalchecktime_iso8601": "2025-12-26T09:09:56Z",
        "clicktimestamp": "2025-12-26 13:57:09",
        "clicktimestamp_iso8601": "2025-12-26T13:57:09Z",
        "clickcount": 82,
        "clicktrend": -9,
        "ssl_error": 0,
        "geo_lat": null,
        "geo_long": null,
        "geo_distance": null,
        "has_extended_info": false
      }
    ]
"""
